<!DOCTYPE html>
<html>
<head>
    <title>WebUSB 2-Way Communication</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        #log {
            font-family: 'Fira Code', 'Courier New', monospace;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container mx-auto max-w-2xl w-full bg-white p-6 md:p-8 rounded-xl shadow-lg">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 text-center mb-6">WebUSB 2-Way Communication</h1>
        
        <div class="connection-controls text-center space-x-2">
            <button id="connectButton" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">Connect to Device</button>
            <button id="disconnectButton" disabled class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">Disconnect</button>
        </div>

        <div id="main-controls" class="controls mt-8" style="display: none;">
            <h2 class="text-xl font-semibold text-gray-700 mb-2">Send Message to Device</h2>
            <div class="input-group flex gap-3">
                <input type="text" id="textToSend" placeholder="Type text and press Enter" class="flex-grow p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                <button id="sendButton" class="px-5 py-3 bg-gray-700 text-white font-semibold rounded-lg shadow-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">Send</button>
            </div>
        </div>

        <div class="log-container mt-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-2">Communication Log</h2>
            <div id="log" class="bg-gray-900 text-white p-4 h-64 overflow-y-scroll rounded-lg leading-relaxed text-sm"></div>
        </div>
    </div>

    <script>
        const connectButton = document.getElementById('connectButton');
        const disconnectButton = document.getElementById('disconnectButton');
        const mainControls = document.getElementById('main-controls');
        const textToSend = document.getElementById('textToSend');
        const sendButton = document.getElementById('sendButton');
        const logElement = document.getElementById('log');

        let device;
        let interfaceNumber;
        let endpointIn, endpointOut;
        const textEncoder = new TextEncoder();
        const textDecoder = new TextDecoder();
        let keepReading = false;

        function log(direction, message) {
            console.log(`${direction}: ${message}`);
            const line = document.createElement('div');
            line.className = 'flex';
            
            const dirSpan = document.createElement('span');
            dirSpan.className = 'w-16 flex-shrink-0';
            if (direction === 'PC >') {
                dirSpan.textContent = '[SENT]';
                dirSpan.className += ' text-cyan-400';
            } else if (direction === '< DEV') {
                dirSpan.textContent = '[RECV]';
                dirSpan.className += ' text-green-400';
            } else if (direction === 'SYS') {
                 dirSpan.textContent = '[SYS]';
                 dirSpan.className += ' text-yellow-400';
            } else { // ERROR
                 dirSpan.textContent = '[ERROR]';
                 dirSpan.className += ' text-red-400';
            }

            const msgSpan = document.createElement('span');
            msgSpan.textContent = message;
            line.appendChild(dirSpan);
            line.appendChild(msgSpan);
            logElement.appendChild(line);
            logElement.scrollTop = logElement.scrollHeight;
        }

        connectButton.addEventListener('click', async () => {
            log('SYS', 'Requesting device...');
            try {
                device = await navigator.usb.requestDevice({ filters: [] });
                
                log('SYS', `Device selected: ${device.manufacturerName} ${device.productName}`);
                await device.open();
                log('SYS', 'Device opened.');

                if (device.configuration === null) {
                    await device.selectConfiguration(1);
                }
                log('SYS', 'Configuration selected.');

                for (const iface of device.configuration.interfaces) {
                    for (const alt of iface.alternates) {
                        if (alt.interfaceClass === 0xFF) { // Vendor-Specific
                            interfaceNumber = iface.interfaceNumber;
                            for (const ep of alt.endpoints) {
                                if (ep.direction === 'out') endpointOut = ep.endpointNumber;
                                if (ep.direction === 'in') endpointIn = ep.endpointNumber;
                            }
                            break;
                        }
                    }
                    if (interfaceNumber !== undefined) break;
                }

                if (interfaceNumber === undefined || endpointIn === undefined || endpointOut === undefined) {
                    throw new Error("Could not find required interface and endpoints.");
                }
                log('SYS', `Found IN endpoint: ${endpointIn}, OUT endpoint: ${endpointOut}`);

                await device.claimInterface(interfaceNumber);
                log('SYS', `Interface ${interfaceNumber} claimed.`);

                connectButton.disabled = true;
                disconnectButton.disabled = false;
                mainControls.style.display = 'block';

                keepReading = true;
                readLoop();

            } catch (error) {
                log('ERROR', error.message);
                console.error(error);
            }
        });
        
        disconnectButton.addEventListener('click', async () => {
            if (!device) return;
            keepReading = false;
            try {
                await device.releaseInterface(interfaceNumber);
                await device.close();
                log('SYS', 'Device disconnected.');
            } catch (error) {
                log('ERROR', `Disconnecting: ${error.message}`);
            }
            device = null;
            connectButton.disabled = false;
            disconnectButton.disabled = true;
            mainControls.style.display = 'none';
        });

        async function sendMessage() {
            if (!device) {
                log('ERROR', 'Not connected.');
                return;
            }
            const message = textToSend.value;
            if (!message) return;

            try {
                log('PC >', message);
                // The .ino sketch expects a newline to terminate the message
                await device.transferOut(endpointOut, textEncoder.encode(message + '\n'));
                textToSend.value = ''; // Clear input after sending
            } catch (error) {
                log('ERROR', `Sending message: ${error.message}`);
            }
        }

        sendButton.addEventListener('click', sendMessage);
        textToSend.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        async function readLoop() {
            while (keepReading) {
                try {
                    let result = await device.transferIn(endpointIn, 64);
                    if (result.status === 'ok' && result.data.byteLength > 0) {
                        const text = textDecoder.decode(result.data);
                        log('< DEV', text);
                    }
                } catch (error) {
                    if (error.message.includes("The device was disconnected")) {
                        log('SYS', 'Device appears to have been disconnected.');
                        if (!disconnectButton.disabled) {
                           await disconnectButton.click();
                        }
                    } else {
                       log('ERROR', `Read loop: ${error.message}`);
                    }
                    keepReading = false;
                }
            }
        }
    </script>
</body>
</html>
