<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DINING WORK | PLATE I Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter for UI, Space Mono for data -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* Base styles inspired by the hardware's minimalist aesthetic */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Cool Gray 100 */
            color: #374151; /* Cool Gray 700 */
        }

        /* Use Space Mono for logs and numerical readouts for a tech feel */
        .font-mono {
            font-family: 'Space Mono', monospace;
        }

        /* Custom card styling for a clean, structured layout */
        .card {
            background-color: white;
            border-radius: 1rem; /* 16px */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 1px solid #e5e7eb; /* Gray 200 */
        }

        /* Animations for a more dynamic feel */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(1rem); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* --- Custom Form Control Styling --- */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
            cursor: pointer;
            width: 100%;
        }
        input[type=range]::-webkit-slider-runnable-track {
            background: #e5e7eb; /* Gray 200 */
            height: 0.5rem; /* 8px */
            border-radius: 0.25rem; /* 4px */
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            margin-top: -0.25rem; /* (thumb height - track height) / 2 */
            background-color: #3b82f6; /* Blue 500 */
            height: 1rem; /* 16px */
            width: 1rem; /* 16px */
            border-radius: 9999px;
            border: 2px solid white;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            transition: background-color 0.2s ease;
        }
        input[type=range]:hover::-webkit-slider-thumb {
            background-color: #2563eb; /* Blue 600 */
        }
        .custom-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* --- Visualizer Styling --- */
        .pot-visualizer .bar-bg {
            background-color: #f3f4f6; /* Gray 100 */
            border-radius: 9999px;
            overflow: hidden;
        }
        .pot-visualizer .bar {
            background-color: #3b82f6; /* Blue 500 */
            transition: width 0.1s linear;
        }
        .btn-indicator {
            transition: all 0.15s ease-out;
            box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05);
        }
        .btn-indicator.active {
            background-color: #3b82f6; /* Blue 500 */
            color: white;
            box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.3);
        }
        
        /* Custom scrollbar for the log area */
        #log-area::-webkit-scrollbar { width: 6px; }
        #log-area::-webkit-scrollbar-track { background: #f3f4f6; border-radius: 3px; }
        #log-area::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        #log-area::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <div class="w-full max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-3">
                <!-- Recreated DINING WORK SVG Logo -->
                <svg class="h-8 w-auto" viewBox="0 0 133 46" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22.5 45C34.9264 45 45 34.9264 45 22.5C45 10.0736 34.9264 0 22.5 0L22.5 4C32.7025 4 41 12.2975 41 22.5C41 32.7025 32.7025 41 22.5 41L22.5 45Z" fill="#111827"/>
                    <path d="M45 0H4V45H0V0H45ZM4 41H41V4H4V41Z" fill="#111827"/>
                    <path d="M88 0H45V4H88V45H45V41H88V0Z" fill="#111827"/>
                    <path d="M45 4L88 41L85.1716 43.8284L42.1716 0.828427L45 4Z" fill="#111827"/>
                    <path d="M133 0H88V4H133V45H88V41H133V0Z" fill="#111827"/>
                </svg>
                <h1 class="text-2xl font-bold text-gray-800 tracking-tight">PLATE I</h1>
            </div>
            <div id="connection-status" class="flex items-center gap-4">
                <div class="text-right">
                    <p id="ble-peer-name" class="font-semibold text-gray-500">Disconnected</p>
                    <p class="text-xs text-gray-400">WebUSB Status</p>
                </div>
                <button id="connectButton" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all active:scale-95">Connect</button>
                <button id="disconnectButton" disabled class="px-4 py-2 bg-gray-200 text-gray-500 font-semibold rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-all disabled:opacity-50 disabled:cursor-not-allowed">Disconnect</button>
            </div>
        </header>

        <!-- Main Content Grid -->
        <main class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            <!-- Left Column: Controls -->
            <div class="lg:col-span-2 flex flex-col gap-6">
                <!-- Welcome/Instructions Message -->
                <div id="welcome-message" class="card p-6 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-300 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                    <h2 class="text-xl font-bold text-gray-700">Ready to Connect</h2>
                    <p class="text-gray-500 mt-1">Click the "Connect" button to link your PLATE I device via USB.</p>
                </div>
                
                <!-- Main Controls (hidden by default) -->
                <div id="main-controls" class="hidden space-y-6">
                    <div class="card p-6 fade-in">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">Global Settings</h2>
                        <div class="grid grid-cols-2 gap-x-6 gap-y-5">
                            <!-- Bank Selection -->
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">Active Bank</label>
                                <div id="bank-selection-grid" class="grid grid-cols-4 sm:grid-cols-6 gap-2"></div>
                            </div>
                            <!-- MIDI Channel -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <label for="midiChannel" class="block text-sm font-medium text-gray-600">MIDI Channel</label>
                                    <span id="midiChannel-value" class="font-mono text-blue-500 text-sm font-semibold"></span>
                                </div>
                                <input type="range" id="midiChannel" min="1" max="16" class="w-full update-on-release" data-action="midi_ch">
                            </div>
                            <!-- Brightness -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <label for="brightness" class="block text-sm font-medium text-gray-600">Brightness</label>
                                    <span id="brightness-value" class="font-mono text-blue-500 text-sm font-semibold"></span>
                                </div>
                                <input type="range" id="brightness" min="3" max="255" class="w-full update-on-release" data-action="brightness">
                            </div>
                            <!-- Button Mode -->
                            <div class="space-y-2">
                                <label for="buttonMode" class="block text-sm font-medium text-gray-600">Button Mode</label>
                                <select id="buttonMode" class="custom-select mt-1 block w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 py-2 px-3 text-sm update-on-release cursor-pointer" data-action="button_mode">
                                    <option value="0">Momentary</option>
                                    <option value="1">Toggle</option>
                                </select>
                            </div>
                            <!-- Action Buttons -->
                            <div class="col-span-2 grid grid-cols-2 gap-3 pt-2">
                                <button id="bleToggleButton" class="w-full px-4 py-2 text-sm text-white font-semibold rounded-md shadow-sm transition-all duration-200 inline-flex items-center justify-center gap-2"></button>
                                <button id="startCalButton" class="w-full px-4 py-2 text-sm bg-yellow-500 text-white font-semibold rounded-md shadow-sm hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500/75 transition-colors duration-200 mt-auto inline-flex items-center justify-center gap-2">
                                    Start EasyCal
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6 fade-in" style="animation-delay: 0.1s;">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">Input Assignments</h2>
                        <div id="assignments-grid" class="grid grid-cols-1 gap-4"></div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Monitor -->
            <div class="lg:col-span-3 flex flex-col gap-6">
                <!-- Real-time Monitor (hidden by default) -->
                <div id="monitor-view" class="card p-6 hidden fade-in" style="animation-delay: 0.2s;">
                    <div class="flex justify-between items-baseline mb-6">
                        <h2 class="text-lg font-bold text-gray-800">Real-time Monitor</h2>
                        <div class="text-right">
                            <p class="text-xs text-gray-400 uppercase font-medium tracking-wider">Last MIDI Message</p>
                            <p id="last-cc-sent" class="font-mono text-2xl text-gray-800 font-bold">-</p>
                        </div>
                    </div>
                    <!-- New Visualizer Layout -->
                    <div class="space-y-6">
                        <div id="cc-pots-container" class="grid grid-cols-2 md:grid-cols-4 gap-x-6 gap-y-5"></div>
                        <div class="border-t border-gray-200 pt-6">
                            <div id="cc-btns-container" class="grid grid-cols-4 gap-4"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Activity Log -->
                <div class="card p-6 flex-grow flex flex-col">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">Activity Log</h2>
                    <div id="log-area" class="flex-grow bg-gray-50 rounded-lg p-3 text-xs font-mono text-gray-500 overflow-y-auto h-48">
                        <p>Waiting for device activity...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- DOM Element References ---
        const connectButton = document.getElementById('connectButton');
        const disconnectButton = document.getElementById('disconnectButton');
        const mainControls = document.getElementById('main-controls');
        const monitorView = document.getElementById('monitor-view');
        const welcomeMessage = document.getElementById('welcome-message');
        const lastCcSentEl = document.getElementById('last-cc-sent');
        const brightnessSlider = document.getElementById('brightness');
        const brightnessValueEl = document.getElementById('brightness-value');
        const midiChannelSlider = document.getElementById('midiChannel');
        const midiChannelValueEl = document.getElementById('midiChannel-value');
        const blePeerNameEl = document.getElementById('ble-peer-name');
        const logArea = document.getElementById('log-area');
        const bleToggleButton = document.getElementById('bleToggleButton');

        // --- WebUSB State Variables ---
        let device, interfaceNumber, endpointIn, endpointOut;
        let keepReading = false;
        const textEncoder = new TextEncoder();
        const textDecoder = new TextDecoder();
        let ccMap = {}; // Maps CC number to its index (0-11)
        let currentSettingsCache = {};
        
        // --- Dynamic Content for BLE Button ---
        const bleOnContent = `Disable BLE`;
        const bleOffContent = `Enable BLE`;

        // --- Core Application Functions ---

        /**
         * Logs a message to the on-screen activity log and the console.
         * @param {string} msg - The message to log.
         */
        const log = (msg) => {
            console.log(`[LOG] ${msg}`);
            const p = document.createElement('p');
            const timestamp = `[${new Date().toLocaleTimeString('en-US', { hour12: false })}] `;
            p.textContent = timestamp + msg;
            
            // Clear placeholder if it exists
            if (logArea.children.length === 1 && logArea.children[0].textContent.startsWith('Waiting')) {
                logArea.innerHTML = '';
            }
            
            logArea.prepend(p);
            // Limit log to 50 entries
            while (logArea.children.length > 50) {
                logArea.removeChild(logArea.lastChild);
            }
        };

        /**
         * Sends a command string to the connected USB device.
         * @param {string} command - The command to send.
         */
        const sendCommand = async (command) => {
            if (!device) {
                log("Device not connected. Cannot send command.");
                return;
            }
            log(`Sending: ${command}`);
            try {
                await device.transferOut(endpointOut, textEncoder.encode(command + '\n'));
            } catch (error) {
                console.error("Send command error:", error);
                log(`Error sending command: ${error.message}`);
                handleDisconnect();
            }
        };

        /**
         * Populates the entire UI based on the settings object received from the device.
         * @param {object} settings - The device settings object.
         */
        const populateUI = (settings) => {
            currentSettingsCache = settings;
            ccMap = {}; // Reset CC map on each settings update

            // --- Populate Global Settings ---
            const bankGrid = document.getElementById('bank-selection-grid');
            bankGrid.innerHTML = '';
            for (let i = 0; i < 12; i++) {
                const bankBtn = document.createElement('button');
                bankBtn.className = `bank-btn h-8 w-8 text-xs font-semibold rounded-md transition-colors duration-150 ${i === settings.activeBank ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`;
                bankBtn.textContent = `${i + 1}`;
                bankBtn.dataset.bank = i;
                bankGrid.appendChild(bankBtn);
            }

            brightnessSlider.value = settings.brightness;
            brightnessValueEl.textContent = settings.brightness;
            midiChannelSlider.value = settings.midiChannel;
            midiChannelValueEl.textContent = settings.midiChannel;
            document.getElementById('buttonMode').value = settings.buttonMode;

            // BLE Toggle Button
            bleToggleButton.innerHTML = settings.bleOn ? bleOnContent : bleOffContent;
            bleToggleButton.classList.toggle('bg-red-500', settings.bleOn);
            bleToggleButton.classList.toggle('hover:bg-red-600', settings.bleOn);
            bleToggleButton.classList.toggle('bg-green-500', !settings.bleOn);
            bleToggleButton.classList.toggle('hover:bg-green-600', !settings.bleOn);

            // --- Populate Assignments & Visualizer ---
            const assignmentsGrid = document.getElementById('assignments-grid');
            const ccPotsContainer = document.getElementById('cc-pots-container');
            const ccBtnsContainer = document.getElementById('cc-btns-container');
            assignmentsGrid.innerHTML = '';
            ccPotsContainer.innerHTML = '';
            ccBtnsContainer.innerHTML = '';

            for (let i = 0; i < 12; i++) {
                const isPot = i < 8;
                const type = isPot ? 'Pot' : 'Btn';
                const num = isPot ? i + 1 : i - 7;
                const cc = settings.ccs[i];
                const label = settings.labels[i] || (type + ' ' + num);
                ccMap[cc] = i; // Map the CC number to its index

                // Create Assignment Card
                const assignmentCard = document.createElement('div');
                assignmentCard.className = 'grid grid-cols-3 gap-3 items-center';
                assignmentCard.innerHTML = `
                    <label class="col-span-1 text-sm font-semibold text-gray-700">${label}</label>
                    <input type="text" value="${label}" maxlength="4" placeholder="Label" class="col-span-1 bg-gray-50 border border-gray-300 rounded-md text-sm p-2 focus:ring-blue-500 focus:border-blue-500 transition-colors update-on-change" data-action="label" data-index="${i}">
                    <input type="number" value="${cc}" min="0" max="127" placeholder="CC" class="col-span-1 bg-gray-50 border border-gray-300 rounded-md text-sm p-2 text-center font-mono focus:ring-blue-500 focus:border-blue-500 transition-colors update-on-release" data-action="cc" data-index="${i}">
                `;
                assignmentsGrid.appendChild(assignmentCard);

                // Create Visualizer Element
                if (isPot) {
                    const potVisualizer = document.createElement('div');
                    potVisualizer.className = 'pot-visualizer space-y-2';
                    potVisualizer.innerHTML = `
                        <div class="flex justify-between items-baseline">
                            <span class="text-sm font-semibold text-gray-700 truncate">${label}</span>
                            <span id="cc-val-${i}" class="text-sm font-mono text-blue-500 font-bold">${settings.currentPotValues ? settings.currentPotValues[i] : 0}</span>
                        </div>
                        <div class="bar-bg h-2 w-full">
                            <div id="cc-bar-${i}" class="bar h-full" style="width: ${settings.currentPotValues ? (settings.currentPotValues[i] / 127) * 100 : 0}%;"></div>
                        </div>
                        <span class="text-xs text-gray-400 font-mono">CC ${cc}</span>
                    `;
                    ccPotsContainer.appendChild(potVisualizer);
                } else {
                    const btnVisualizer = document.createElement('div');
                    btnVisualizer.className = 'flex flex-col items-center gap-2';
                    btnVisualizer.innerHTML = `
                        <div id="cc-btn-${i}" class="btn-indicator bg-gray-200 text-gray-600 h-16 w-16 rounded-lg flex items-center justify-center text-sm font-bold font-mono">
                            ${cc}
                        </div>
                        <span class="text-sm font-semibold text-gray-700 truncate">${label}</span>
                    `;
                    ccBtnsContainer.appendChild(btnVisualizer);
                }
            }
            
            // Set initial values for visualizers if available
            if (settings.currentPotValues) {
                settings.currentPotValues.forEach((value, index) => {
                    updateCCVisualizer(settings.ccs[index], value);
                });
            }
        };

        /**
         * Updates a single visualizer element based on an incoming CC message.
         * @param {number} cc - The MIDI CC number.
         * @param {number} value - The MIDI CC value (0-127).
         */
        const updateCCVisualizer = (cc, value) => {
            const index = ccMap[cc];
            if (index === undefined) return;

            lastCcSentEl.textContent = `CC ${cc}: ${value}`;
            
            if (index < 8) { // It's a Potentiometer
                const bar = document.getElementById(`cc-bar-${index}`);
                const valLabel = document.getElementById(`cc-val-${index}`);
                if (bar) bar.style.width = `${(value / 127) * 100}%`;
                if (valLabel) valLabel.textContent = value;
            } else { // It's a Button
                const btn = document.getElementById(`cc-btn-${index}`);
                if (btn) btn.classList.toggle('active', value > 64);
            }
        };

        /**
         * Continuously reads data from the device in a loop.
         */
        async function readLoop() {
            let incomingData = "";
            while (keepReading) {
                try {
                    let result = await device.transferIn(endpointIn, 512);
                    if (result.status === 'ok' && result.data.byteLength > 0) {
                        incomingData += textDecoder.decode(result.data, { stream: true });
                        let newlineIndex;
                        while ((newlineIndex = incomingData.indexOf('\n')) !== -1) {
                            const line = incomingData.slice(0, newlineIndex).trim();
                            incomingData = incomingData.slice(newlineIndex + 1);
                            
                            if (line.startsWith('{')) { // JSON settings object
                                try {
                                    populateUI(JSON.parse(line));
                                } catch (e) {
                                    log(`JSON Parse Error: ${e.message}`);
                                }
                            } else if (line.startsWith('cc:')) { // Real-time CC message
                                const parts = line.substring(3).split(',');
                                if (parts.length === 2) updateCCVisualizer(parseInt(parts[0]), parseInt(parts[1]));
                            } else if (line.startsWith('bank_changed:')) { // Bank change confirmation
                                log("Bank changed. Requesting new settings.");
                                setTimeout(() => sendCommand('get_settings'), 100);
                            } else if (line) { // Generic log message from device
                                log(`Device: ${line}`);
                            }
                        }
                    }
                } catch (error) {
                    if (error.message.includes("disconnected")) {
                        log("Device disconnected.");
                        handleDisconnect();
                    } else {
                        log(`Read loop error: ${error.message}`);
                    }
                    keepReading = false;
                }
            }
        }

        /**
         * Handles the UI state change for a device disconnect.
         */
        const handleDisconnect = async () => {
            if (!device) return;
            keepReading = false;
            try {
                await device.close();
            } catch (error) {
                 log(`Disconnect error: ${error.message}`);
            } finally {
                device = null;
                connectButton.disabled = false;
                disconnectButton.disabled = true;
                mainControls.classList.add('hidden');
                monitorView.classList.add('hidden');
                welcomeMessage.style.display = 'block';
                blePeerNameEl.textContent = 'Disconnected';
                blePeerNameEl.classList.remove('text-green-500');
                blePeerNameEl.classList.add('text-gray-500');
                log("Disconnected.");
            }
        }

        // --- Event Listeners ---

        connectButton.addEventListener('click', async () => {
            log("Attempting to connect...");
            connectButton.disabled = true;
            try {
                device = await navigator.usb.requestDevice({ filters: [{ vendorId: 0x000a }] });
                await device.open();
                if (device.configuration === null) await device.selectConfiguration(1);
                
                // Find the correct interface and endpoints
                for (const iface of device.configuration.interfaces) {
                    for (const alt of iface.alternates) {
                        if (alt.interfaceClass === 0xFF) { // Vendor-specific class
                            interfaceNumber = iface.interfaceNumber;
                            for (const ep of alt.endpoints) {
                                if (ep.direction === 'out') endpointOut = ep.endpointNumber;
                                if (ep.direction === 'in') endpointIn = ep.endpointNumber;
                            }
                        }
                    }
                }
                
                if (interfaceNumber === undefined) throw new Error("Device interface not found.");
                
                await device.claimInterface(interfaceNumber);
                await device.controlTransferOut({ requestType: 'class', recipient: 'interface', request: 0x22, value: 0x01, index: interfaceNumber });
                
                log("Device connected successfully!");
                disconnectButton.disabled = false;
                welcomeMessage.style.display = 'none';
                mainControls.classList.remove('hidden');
                monitorView.classList.remove('hidden');
                blePeerNameEl.textContent = 'Connected';
                blePeerNameEl.classList.remove('text-gray-500');
                blePeerNameEl.classList.add('text-green-500');

                keepReading = true;
                readLoop();
                await sendCommand("get_settings");
            } catch (error) {
                log(`Connection failed: ${error.message}`);
                connectButton.disabled = false;
            }
        });

        disconnectButton.addEventListener('click', handleDisconnect);

        // Global event listener for UI controls
        document.addEventListener('input', (e) => {
            if (e.target.id === 'brightness') brightnessValueEl.textContent = e.target.value;
            else if (e.target.id === 'midiChannel') midiChannelValueEl.textContent = e.target.value;
        });

        document.addEventListener('change', (e) => {
            const t = e.target;
            if (t.classList.contains('update-on-release') || t.classList.contains('update-on-change')) {
                const action = t.dataset.action;
                const index = t.dataset.index;
                const value = t.value;
                let cmd = `set_${action}=${index ? index + ',' : ''}${value}`;
                sendCommand(cmd);
                // Refresh settings after changing a CC or label to update the UI everywhere
                if (action === 'cc' || action === 'label') {
                    setTimeout(() => sendCommand('get_settings'), 200);
                }
            }
        });

        document.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            if (target.classList.contains('bank-btn')) {
                sendCommand(`set_bank=${target.dataset.bank}`);
            } else if (target.id === 'bleToggleButton') {
                sendCommand('toggle_ble');
            } else if (target.id === 'startCalButton') {
                sendCommand('start_cal');
                log("Calibration started. Follow device instructions.");
            }
        });
    </script>
</body>
</html>
