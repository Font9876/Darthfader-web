<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PLATE 1 | Configurator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #f4f4f5; /* Zinc 100 */
            --panel-bg-color: #ffffff;
            --border-color: #e4e4e7; /* Zinc 200 */
            --text-primary: #18181b; /* Zinc 900 */
            --text-secondary: #71717a; /* Zinc 500 */
            --accent-color: #18181b; /* Zinc 900 for accent */
            --accent-text-color: #ffffff;
            --success-color: #16a34a; /* Green 600 */
            --warning-color: #f59e0b; /* Amber 500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
        }

        /* Custom SVG for the logo */
        .logo-svg-sm {
            width: 100px;
            height: auto;
        }

        /* Custom button styles */
        .btn { @apply font-semibold py-2 px-4 rounded-lg transition-all duration-200 ease-in-out flex items-center justify-center gap-2; }
        .btn-primary { @apply bg-black text-white hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black; }
        .btn-secondary { @apply bg-white border border-gray-300 text-gray-800 hover:bg-gray-50; }
        .btn-icon { @apply p-2 rounded-full hover:bg-gray-200; }

        /* Input field styling */
        .input-field { @apply w-full bg-gray-50 border border-gray-300 rounded-md text-sm p-2 focus:ring-black focus:border-black transition-colors; }
        .input-label { @apply block text-sm font-medium text-gray-600 mb-1; }

        /* Range slider styling */
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; width: 100%; }
        input[type=range]::-webkit-slider-runnable-track { background: #e5e7eb; height: 4px; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; margin-top: -6px; background-color: var(--accent-color);
            height: 16px; width: 16px; border-radius: 50%;
            transition: transform 0.15s ease;
        }
        input[type=range]:active::-webkit-slider-thumb { transform: scale(1.2); }

        /* Fade-in animation */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }

        /* Visualizer styles */
        .visualizer-bar { transition: height 0.1s linear; }
        .visualizer-btn { transition: all 0.1s ease; }
        .visualizer-btn.active { background-color: var(--accent-color); border-color: var(--accent-color); }
        .visualizer-btn.active span { color: var(--accent-text-color); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-lg border-b border-gray-200 sticky top-0 z-10">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center gap-2">
                    <svg class="logo-svg-sm" viewBox="0 0 220 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2 38.5V98H22L22 58.5L52 98H70L40 58.5H108V98H128V58.5L158 98H176L146 58.5H188C204.5 58.5 218 45.031 218 28.5C218 12.469 204.5 2 188 2H2L22 38.5H2ZM22 38.5V2H188C193.523 2 198 6.477 198 12C198 17.523 193.523 22 188 22H52C30 22 22 38.5 22 38.5Z" stroke="black" stroke-width="4"/>
                    </svg>
                    <span class="text-xl font-bold text-gray-500 tracking-tighter">/ Configurator</span>
                </div>
                <!-- Connection Controls -->
                <div class="flex items-center gap-3">
                    <div id="status-indicator" class="w-3 h-3 rounded-full bg-gray-400" title="Disconnected"></div>
                    <p id="device-name" class="text-sm font-medium text-gray-600 hidden md:block">No Device</p>
                    <button id="connectButton" class="btn btn-primary text-sm">Connect</button>
                    <button id="disconnectButton" class="btn btn-secondary text-sm hidden">Disconnect</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Welcome / Disconnected State -->
        <div id="welcome-message" class="text-center py-24">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            <h1 class="mt-4 text-3xl font-bold tracking-tight text-gray-800">PLATE 1 Configurator</h1>
            <p class="mt-2 text-base text-gray-500">Connect your device via USB to begin.</p>
        </div>

        <!-- Main Dashboard (Hidden by default) -->
        <div id="dashboard" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- Left Column: Banks & Global Settings -->
                <div class="lg:col-span-1 space-y-8">
                    <!-- Bank Selection -->
                    <section class="bg-white p-6 rounded-xl border border-gray-200">
                        <h2 class="text-lg font-bold mb-4">Banks</h2>
                        <div id="bank-selection-grid" class="grid grid-cols-4 gap-2"></div>
                    </section>

                    <!-- Global Settings -->
                    <section class="bg-white p-6 rounded-xl border border-gray-200">
                        <h2 class="text-lg font-bold mb-4">Global Settings</h2>
                        <div class="space-y-5">
                            <div>
                                <div class="flex justify-between items-center"><label for="midiChannel" class="input-label">MIDI Channel</label><span id="midiChannel-value" class="font-mono text-sm font-semibold">1</span></div>
                                <input type="range" id="midiChannel" min="1" max="16" class="w-full update-on-release" data-action="midi_ch">
                            </div>
                            <div>
                                <label for="buttonMode" class="input-label">Button Mode</label>
                                <select id="buttonMode" class="input-field update-on-release" data-action="button_mode"><option value="0">Momentary</option><option value="1">Toggle</option></select>
                            </div>
                            <button id="startCalButton" class="btn btn-secondary w-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.055 11H5a2 2 0 012 2v1a1 1 0 001 1h4a1 1 0 001-1v-1a2 2 0 012-2h1.945a8.002 8.002 0 00-11.89 0zM10 2a8 8 0 100 16 8 8 0 000-16zM6.343 6.343a.75.75 0 011.06 0l2.25 2.25a.75.75 0 01-1.06 1.06L6.343 7.404a.75.75 0 010-1.06zm7.314 0a.75.75 0 010 1.06l-2.25 2.25a.75.75 0 11-1.06-1.06l2.25-2.25a.75.75 0 011.06 0z" clip-rule="evenodd" /></svg>
                                Start Calibration
                            </button>
                        </div>
                    </section>
                </div>

                <!-- Middle Column: Assignments & Visualizer -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Input Assignments -->
                    <section class="bg-white p-6 rounded-xl border border-gray-200">
                        <h2 class="text-lg font-bold mb-4">Input Assignments (Bank <span id="current-bank-label">1</span>)</h2>
                        <div id="assignments-grid" class="grid grid-cols-2 md:grid-cols-4 gap-6"></div>
                    </section>
                    
                    <!-- Real-time Visualizer -->
                    <section class="bg-white p-6 rounded-xl border border-gray-200">
                        <h2 class="text-lg font-bold mb-4">Real-time Monitor</h2>
                        <div class="grid grid-cols-2 gap-8">
                            <!-- Faders -->
                            <div class="col-span-2 md:col-span-1">
                                <p class="text-sm font-medium text-gray-500 mb-2">Faders</p>
                                <div id="cc-pots-container" class="grid grid-cols-4 gap-6 h-40 items-end"></div>
                            </div>
                            <!-- Buttons -->
                            <div class="col-span-2 md:col-span-1">
                                <p class="text-sm font-medium text-gray-500 mb-2">Buttons</p>
                                <div id="cc-btns-container" class="grid grid-cols-4 gap-4 h-40 items-start"></div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- DOM Elements ---
        const connectButton = document.getElementById('connectButton');
        const disconnectButton = document.getElementById('disconnectButton');
        const dashboard = document.getElementById('dashboard');
        const welcomeMessage = document.getElementById('welcome-message');
        const midiChannelSlider = document.getElementById('midiChannel');
        const midiChannelValueEl = document.getElementById('midiChannel-value');
        const statusIndicator = document.getElementById('status-indicator');
        const deviceNameEl = document.getElementById('device-name');
        
        // --- WebUSB State ---
        let device, interfaceNumber, endpointIn, endpointOut;
        let keepReading = false;
        const textEncoder = new TextEncoder();
        const textDecoder = new TextDecoder();
        let ccMap = {};
        let currentBank = 0;

        // --- Core Functions ---
        const log = (msg, type = 'info') => {
            console.log(`[${type.toUpperCase()}] ${msg}`);
            // In a real app, you might show a toast notification here.
        };

        const sendCommand = async (command) => {
            if (!device) {
                log("Device not connected.", 'warn');
                return;
            }
            try {
                await device.transferOut(endpointOut, textEncoder.encode(command + '\n'));
            } catch (error) {
                console.error("Send command error:", error);
                log(`Error sending command: ${error.message}`, 'error');
            }
        };

        const createAssignmentCard = (index, cc, label) => {
            const isPot = index < 4;
            const type = isPot ? 'Fader' : 'Button';
            const num = isPot ? index + 1 : index - 3;
            const card = document.createElement('div');
            card.innerHTML = `
                <div>
                    <label class="input-label">${type} ${num}</label>
                    <input type="text" value="${label}" maxlength="4" placeholder="Name" class="input-field update-on-change" data-action="label" data-index="${index}">
                </div>
                <div class="mt-2">
                    <label class="input-label">CC#</label>
                    <input type="number" value="${cc}" min="0" max="127" class="input-field font-mono text-center update-on-release" data-action="cc" data-index="${index}">
                </div>
            `;
            return card;
        };
        
        const createVisualizer = (index, cc, label) => {
            const isPot = index < 4;
            if (isPot) {
                const faderEl = document.createElement('div');
                faderEl.className = 'flex flex-col items-center h-full';
                faderEl.innerHTML = `
                    <div class="w-2 h-full bg-gray-200 rounded-full overflow-hidden flex flex-col justify-end">
                        <div id="cc-bar-${index}" class="visualizer-bar w-full bg-black rounded-full" style="height: 0%;"></div>
                    </div>
                    <span class="text-xs font-mono mt-2 text-gray-500">${label}</span>
                `;
                return faderEl;
            } else {
                const btnEl = document.createElement('div');
                btnEl.className = 'flex flex-col items-center';
                btnEl.innerHTML = `
                    <div id="cc-btn-${index}" class="visualizer-btn h-12 w-12 rounded-lg border-2 border-gray-300 flex items-center justify-center">
                        <span class="text-black text-sm font-mono font-semibold">${cc}</span>
                    </div>
                    <span class="text-xs font-mono mt-2 text-gray-500">${label}</span>
                `;
                return btnEl;
            }
        };

        const populateUI = (settings) => {
            currentBank = settings.activeBank;
            document.getElementById('current-bank-label').textContent = currentBank + 1;

            const bankGrid = document.getElementById('bank-selection-grid');
            bankGrid.innerHTML = '';
            for (let i = 0; i < 12; i++) {
                const bankBtn = document.createElement('button');
                bankBtn.className = 'bank-btn p-3 text-sm font-semibold rounded-lg transition-colors duration-150';
                bankBtn.textContent = `${i + 1}`;
                bankBtn.dataset.bank = i;
                if (i === currentBank) {
                    bankBtn.classList.add('bg-black', 'text-white', 'font-bold');
                } else {
                    bankBtn.classList.add('bg-gray-100', 'hover:bg-gray-200');
                }
                bankGrid.appendChild(bankBtn);
            }

            midiChannelSlider.value = settings.midiChannel;
            midiChannelValueEl.textContent = settings.midiChannel;
            document.getElementById('buttonMode').value = settings.buttonMode;
            
            const assignmentsGrid = document.getElementById('assignments-grid');
            const ccPotsContainer = document.getElementById('cc-pots-container');
            const ccBtnsContainer = document.getElementById('cc-btns-container');
            assignmentsGrid.innerHTML = '';
            ccPotsContainer.innerHTML = '';
            ccBtnsContainer.innerHTML = '';
            ccMap = {};

            // Assuming 4 faders and 4 buttons
            for (let i = 0; i < 8; i++) {
                const cc = settings.ccs[i];
                const label = settings.labels[i] || (i < 4 ? `F${i+1}` : `B${i-3}`);
                ccMap[cc] = i;

                assignmentsGrid.appendChild(createAssignmentCard(i, cc, label));
                
                const visualizerEl = createVisualizer(i, cc, label);
                if (i < 4) {
                    ccPotsContainer.appendChild(visualizerEl);
                } else {
                    ccBtnsContainer.appendChild(visualizerEl);
                }
            }
            
            // Update initial values if present
            if (settings.currentPotValues) {
                settings.currentPotValues.forEach((value, index) => {
                    updateCCVisualizer(settings.ccs[index], value);
                });
            }
        };

        const updateCCVisualizer = (cc, value) => {
            const index = ccMap[cc];
            if (index === undefined) return;

            if (index < 4) { // Fader
                const bar = document.getElementById(`cc-bar-${index}`);
                if (bar) bar.style.height = `${(value / 127) * 100}%`;
            } else { // Button
                const btn = document.getElementById(`cc-btn-${index}`);
                if (btn) btn.classList.toggle('active', value > 64);
            }
        };

        async function readLoop() {
            let incomingData = "";
            while (keepReading) {
                try {
                    let result = await device.transferIn(endpointIn, 512);
                    if (result.status === 'ok' && result.data.byteLength > 0) {
                        incomingData += textDecoder.decode(result.data, { stream: true });
                        let newlineIndex;
                        while ((newlineIndex = incomingData.indexOf('\n')) !== -1) {
                            const line = incomingData.slice(0, newlineIndex).trim();
                            incomingData = incomingData.slice(newlineIndex + 1);
                            if (line.startsWith('{')) {
                                try {
                                    populateUI(JSON.parse(line));
                                } catch (e) {
                                    log(`JSON Parse Error: ${e.message}`, 'error');
                                }
                            } else if (line.startsWith('cc:')) {
                                const parts = line.substring(3).split(',');
                                if (parts.length === 2) updateCCVisualizer(parseInt(parts[0]), parseInt(parts[1]));
                            } else if (line.startsWith('bank_changed:')) {
                                log("Bank changed. Requesting new settings.");
                                setTimeout(() => sendCommand('get_settings'), 100);
                            } else {
                                log(`Device: ${line}`);
                            }
                        }
                    }
                } catch (error) {
                    if (error.message.includes("disconnected")) {
                        handleDisconnect();
                    } else {
                        log(`Read loop error: ${error.message}`, 'error');
                    }
                    keepReading = false;
                }
            }
        }
        
        const handleConnect = () => {
            log("Device connected successfully!");
            deviceNameEl.textContent = device.productName || 'PLATE 1';
            deviceNameEl.classList.remove('hidden');
            statusIndicator.classList.remove('bg-gray-400');
            statusIndicator.classList.add('bg-green-500');
            statusIndicator.title = 'Connected';

            connectButton.classList.add('hidden');
            disconnectButton.classList.remove('hidden');
            
            welcomeMessage.classList.add('hidden');
            dashboard.classList.remove('hidden');
            dashboard.classList.add('fade-in');

            keepReading = true;
            readLoop();
            sendCommand("get_settings");
        };

        const handleDisconnect = () => {
            device = null;
            keepReading = false;
            
            deviceNameEl.textContent = 'No Device';
            deviceNameEl.classList.add('hidden');
            statusIndicator.classList.add('bg-gray-400');
            statusIndicator.classList.remove('bg-green-500');
            statusIndicator.title = 'Disconnected';

            connectButton.classList.remove('hidden');
            disconnectButton.classList.add('hidden');

            dashboard.classList.add('hidden');
            welcomeMessage.classList.remove('hidden');
            log("Device disconnected.");
        };

        connectButton.addEventListener('click', async () => {
            log("Attempting to connect...");
            try {
                device = await navigator.usb.requestDevice({ filters: [{ vendorId: 0x000a }] });
                await device.open();
                if (device.configuration === null) await device.selectConfiguration(1);
                
                // Find the correct interface and endpoints
                for (const iface of device.configuration.interfaces) {
                    for (const alt of iface.alternates) {
                        if (alt.interfaceClass === 0xFF) { // Vendor-specific class
                            interfaceNumber = iface.interfaceNumber;
                            for (const ep of alt.endpoints) {
                                if (ep.direction === 'out') endpointOut = ep.endpointNumber;
                                if (ep.direction === 'in') endpointIn = ep.endpointNumber;
                            }
                        }
                    }
                }
                
                if (interfaceNumber === undefined) throw new Error("Compatible interface not found.");
                
                await device.claimInterface(interfaceNumber);
                await device.controlTransferOut({ requestType: 'class', recipient: 'interface', request: 0x22, value: 0x01, index: interfaceNumber });
                
                handleConnect();

            } catch (error) {
                log(`Connection failed: ${error.message}`, 'error');
            }
        });

        disconnectButton.addEventListener('click', async () => {
            if (!device) return;
            try {
                await device.controlTransferOut({ requestType: 'class', recipient: 'interface', request: 0x22, value: 0x00, index: interfaceNumber });
                await device.releaseInterface(interfaceNumber);
                await device.close();
            } catch (error) {
                log(`Disconnect error: ${error.message}`, 'error');
            } finally {
                handleDisconnect();
            }
        });

        document.addEventListener('input', (e) => {
            if (e.target.id === 'midiChannel') midiChannelValueEl.textContent = e.target.value;
        });

        document.addEventListener('change', (e) => {
            const t = e.target;
            if (t.classList.contains('update-on-release') || t.classList.contains('update-on-change')) {
                const action = t.dataset.action;
                let cmd = `set_${action}=${t.dataset.index ? t.dataset.index + ',' : ''}${t.value}`;
                sendCommand(cmd);
                if (action === 'cc' || action === 'label') {
                    // Refresh settings after a short delay to see changes reflected
                    setTimeout(() => sendCommand('get_settings'), 200);
                }
            }
        });

        document.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            if (target.classList.contains('bank-btn')) {
                sendCommand(`set_bank=${target.dataset.bank}`);
            } else if (target.id === 'startCalButton') {
                sendCommand('start_cal');
                log("Calibration started. Follow device instructions.");
            }
        });
    </script>
</body>
</html>
