<!DOCTYPE html>
<html>
<head>
    <title>WebUSB LED Control</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding-top: 20px; }
        .controls { text-align: center; margin-bottom: 20px; }
        button { font-size: 18px; padding: 10px 15px; margin: 5px; cursor: pointer; }
        #log-container { width: 80%; max-width: 800px; }
        #log { background-color: #222; color: #0f0; font-family: monospace; white-space: pre-wrap; padding: 15px; height: 300px; overflow-y: scroll; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="controls">
        <h1>WebUSB LED Control 💡</h1>
        <button id="connectButton">Connect to Device</button>
        <p>
            <button id="ledOnButton" disabled>Turn LED ON</button>
            <button id="ledOffButton" disabled>Turn LED OFF</button>
        </p>
    </div>

    <div id="log-container">
        <h3>Debug Log:</h3>
        <pre id="log"></pre>
    </div>

    <script>
        const connectButton = document.getElementById('connectButton');
        const ledOnButton = document.getElementById('ledOnButton');
        const ledOffButton = document.getElementById('ledOffButton');
        const logElement = document.getElementById('log');

        let device;
        let interfaceNumber;
        let endpointOut;

        function log(message) {
            console.log(message);
            logElement.textContent += `> ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight; // Auto-scroll
        }

        connectButton.addEventListener('click', async () => {
            log("Attempting to connect...");
            try {
                // IMPORTANT: Replace with your device's Vendor and Product ID
                const filters = [
                    { vendorId: 0x000a } // Example: Adafruit's Vendor ID
                    // { vendorId: 0x239A, productId: 0x80F7 } // More specific
                ];

                log(`Requesting device with filters: ${JSON.stringify(filters)}`);
                device = await navigator.usb.requestDevice({ filters });
                
                log(`Device selected: ${device.manufacturerName} ${device.productName}`);
                log("Opening device...");
                await device.open();
                
                log("Selecting configuration...");
                await device.selectConfiguration(1);

                log("Searching for the correct interface...");
                const interfaces = device.configuration.interfaces;
                for (const iface of interfaces) {
                    // Look for a vendor-specific interface, which is what Adafruit_USBD_WebUSB creates.
                    if (iface.alternate.interfaceClass === 0xFF) { // 0xFF is the code for Vendor-Specific
                        interfaceNumber = iface.interfaceNumber;
                        log(`Found vendor-specific interface: ${interfaceNumber}`);
                        
                        // Find the OUT endpoint on this interface
                        for (const ep of iface.alternate.endpoints) {
                            if (ep.direction === 'out') {
                                endpointOut = ep.endpointNumber;
                                log(`Found OUT endpoint: ${endpointOut}`);
                                break;
                            }
                        }
                        break;
                    }
                }

                if (interfaceNumber === undefined || endpointOut === undefined) {
                    throw new Error("Could not find a valid WebUSB interface or endpoint.");
                }

                log(`Claiming interface ${interfaceNumber}...`);
                await device.claimInterface(interfaceNumber);

                log("✅ Device connected and ready!");
                connectButton.disabled = true;
                ledOnButton.disabled = false;
                ledOffButton.disabled = false;

            } catch (error) {
                log(`❌ ERROR: ${error.message}`);
                console.error("Connection failed:", error);
            }
        });

        async function sendData(data) {
            if (!device) {
                log("Device not connected!");
                return;
            }
            try {
                const dataToSend = new TextEncoder().encode(data);
                log(`Sending data ('${data}') to endpoint ${endpointOut}...`);
                await device.transferOut(endpointOut, dataToSend);
                log("Data sent successfully.");
            } catch (error) {
                log(`❌ ERROR sending data: ${error.message}`);
            }
        }

        ledOnButton.addEventListener('click', () => sendData('1'));
        ledOffButton.addEventListener('click', () => sendData('0'));
    </script>
</body>
</html>
