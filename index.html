<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebUSB nRF52 Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .log-container::-webkit-scrollbar {
            width: 8px;
        }
        .log-container::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .log-container::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        .log-container::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="h-full flex items-center justify-center text-gray-200 p-4">

    <div class="w-full max-w-2xl bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 flex flex-col gap-6">
        <!-- Header -->
        <div class="text-center">
            <h1 class="text-3xl font-bold text-white">WebUSB Device Control</h1>
            <p id="status" class="text-sm text-red-400 mt-2 font-medium">Status: Disconnected</p>
        </div>

        <!-- Connection Buttons -->
        <div class="flex flex-col sm:flex-row justify-center gap-4">
            <button id="connectButton" class="w-full sm:w-auto flex-grow bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75">
                Connect to Device
            </button>
            <button id="inspectButton" class="w-full sm:w-auto hidden bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75">
                Inspect Device
            </button>
        </div>

        <!-- Controls -->
        <div id="controls" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4">
            <button id="ledOnButton" class="control-button bg-green-600 hover:bg-green-500">LED ON</button>
            <button id="ledOffButton" class="control-button bg-red-600 hover:bg-red-500">LED OFF</button>
            <button id="readSettingsButton" class="control-button bg-blue-600 hover:bg-blue-500">Read Settings</button>
            <button id="factoryResetButton" class="control-button bg-yellow-600 hover:bg-yellow-500 text-gray-900">Factory Reset</button>
        </div>

        <!-- Log Output -->
        <div class="flex flex-col gap-2">
            <div class="flex justify-between items-center">
                 <h2 class="text-lg font-semibold text-white">Device Log</h2>
                 <button id="clearLogButton" class="text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 font-medium py-1 px-3 rounded-md transition-colors">Clear Log</button>
            </div>
            <pre id="log" class="log-container bg-gray-900 text-sm p-4 rounded-lg h-64 overflow-y-auto whitespace-pre-wrap break-words"></pre>
        </div>
    </div>

    <script>
        // --- DOM Element References ---
        const connectButton = document.getElementById('connectButton');
        const inspectButton = document.getElementById('inspectButton');
        const statusDisplay = document.getElementById('status');
        const controlsDiv = document.getElementById('controls');
        const ledOnButton = document.getElementById('ledOnButton');
        const ledOffButton = document.getElementById('ledOffButton');
        const readSettingsButton = document.getElementById('readSettingsButton');
        const factoryResetButton = document.getElementById('factoryResetButton');
        const logContainer = document.getElementById('log');
        const clearLogButton = document.getElementById('clearLogButton');

        // --- WebUSB State Variables ---
        let device;
        let isConnected = false;
        const textDecoder = new TextDecoder();
        const textEncoder = new TextEncoder();

        // --- WebUSB Device Filters ---
        const filters = [ { vendorId: 0x000a } ]; // UPDATED Vendor ID

        // --- Event Listeners ---
        connectButton.addEventListener('click', handleConnectClick);
        inspectButton.addEventListener('click', inspectDevice);
        ledOnButton.addEventListener('click', () => sendCommand('LED_ON\n'));
        ledOffButton.addEventListener('click', () => sendCommand('LED_OFF\n'));
        readSettingsButton.addEventListener('click', () => sendCommand('READ_SETTINGS\n'));
        factoryResetButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to perform a factory reset? This cannot be undone.')) {
                sendCommand('FACTORY_RESET\n');
            }
        });
        clearLogButton.addEventListener('click', () => {
            logContainer.textContent = '';
            log('Log cleared.');
        });
        
        async function handleConnectClick() {
            if (isConnected) {
                await disconnect();
            } else {
                await connect();
            }
        }

        async function connect() {
            try {
                log('Requesting device...');
                device = await navigator.usb.requestDevice({ filters });
                inspectButton.classList.remove('hidden');

                log('Opening device...');
                await device.open();
                
                log(`Device opened: ${device.manufacturerName} ${device.productName}`);

                await device.selectConfiguration(1);

                // UPDATED based on your "Inspect Device" output.
                // Your device uses Interface #1 for serial data (Class 0xa).
                const interfaceNumber = 1; 
                await device.claimInterface(interfaceNumber);
                log(`Interface ${interfaceNumber} claimed.`);

                updateUIForConnection();
                readLoop();

            } catch (error) {
                log(`ERROR: ${error.message}`);
                if (error.message.includes('claim interface')) {
                    log('--------------------------------------------------');
                    log('DEBUGGING HELP:');
                    log('This error usually means one of two things:');
                    log('1. Another program (like the Arduino IDE Serial Monitor or a terminal app) is already connected to the device. Please close it and try again.');
                    log('2. The "interface number" is incorrect for your device. Click the "Inspect Device" button to see a list of available interfaces and their numbers.');
                    log('--------------------------------------------------');
                }
                console.error(error);
            }
        }

        async function disconnect() {
            if (!device) return;
            try {
                // Before closing, it's good practice to release the interface
                await device.releaseInterface(1); // Use the same interface number
                log('Interface released.');
                await device.close();
                log('Device closed.');
            } catch (error) {
                log(`ERROR during disconnect: ${error.message}`);
                console.error(error);
            } finally {
                device = null;
                updateUIForDisconnection();
            }
        }
        
        function inspectDevice() {
            if (!device) {
                log('ERROR: No device selected. Please click "Connect" first.');
                return;
            }
            log('--- Inspecting Device ---');
            console.log('Full device object:', device);

            let info = `\nDevice: ${device.manufacturerName} ${device.productName}\n`;
            info += `Configurations: ${device.configurations.length}\n`;

            device.configurations.forEach((config, configIndex) => {
                info += `\n  [Configuration ${config.configurationValue}]\n`;
                config.interfaces.forEach(intf => {
                    info += `    > Interface #${intf.interfaceNumber}\n`;
                    intf.alternates.forEach(alt => {
                        info += `      - Alternate Setting: ${alt.alternateSetting}\n`;
                        info += `      - Interface Class: 0x${alt.interfaceClass.toString(16)}\n`;
                        if (alt.endpoints.length > 0) {
                            alt.endpoints.forEach(endpoint => {
                                info += `        * Endpoint #${endpoint.endpointNumber} | Direction: ${endpoint.direction} | Type: ${endpoint.type}\n`;
                            });
                        } else {
                            info += '        * No endpoints\n';
                        }
                    });
                });
            });
            log(info);
            log('--- End Inspection ---');
            log('Look for the interface with class 0x0a (CDC-Data) or similar. Note its Interface # and Endpoint #s for the "in" and "out" directions.');
        }

        async function sendCommand(command) {
            if (!device || !isConnected) {
                log('ERROR: Not connected.');
                return;
            }
            try {
                // UPDATED based on your "Inspect Device" output.
                // The OUT endpoint for Interface #1 is Endpoint #1.
                const endpointNumber = 1;
                const data = textEncoder.encode(command);
                await device.transferOut(endpointNumber, data);
            } catch (error) {
                log(`ERROR sending command: ${error.message}`);
                console.error(error);
            }
        }

        async function readLoop() {
            // UPDATED based on your "Inspect Device" output.
            // The IN endpoint for Interface #1 is Endpoint #2.
            const endpointNumber = 2;
            try {
                while (isConnected) {
                    const result = await device.transferIn(endpointNumber, 64);
                    if (result.data && result.data.byteLength > 0) {
                        const text = textDecoder.decode(result.data);
                        log(text, 'device');
                    }
                }
            } catch (error) {
                if (isConnected) {
                   log(`ERROR during read: ${error.message}`);
                   console.error(error);
                   await disconnect();
                }
            }
        }

        function updateUIForConnection() {
            isConnected = true;
            statusDisplay.textContent = 'Status: Connected';
            statusDisplay.classList.remove('text-red-400');
            statusDisplay.classList.add('text-green-400');
            connectButton.textContent = 'Disconnect';
            connectButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-500');
            connectButton.classList.add('bg-red-600', 'hover:bg-red-500');
            controlsDiv.classList.remove('hidden');
            controlsDiv.classList.add('grid');
            inspectButton.classList.add('hidden');
        }

        function updateUIForDisconnection() {
            isConnected = false;
            device = null;
            statusDisplay.textContent = 'Status: Disconnected';
            statusDisplay.classList.remove('text-green-400');
            statusDisplay.classList.add('text-red-400');
            connectButton.textContent = 'Connect to Device';
            connectButton.classList.remove('bg-red-600', 'hover:bg-red-500');
            connectButton.classList.add('bg-indigo-600', 'hover:bg-indigo-500');
            controlsDiv.classList.add('hidden');
            controlsDiv.classList.remove('grid');
            inspectButton.classList.add('hidden');
        }

        function log(message, source = 'app') {
            const prefix = source === 'device' ? '<< ' : '>> ';
            logContainer.textContent += prefix + message.trimEnd() + '\n';
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        document.querySelectorAll('.control-button').forEach(button => {
            button.classList.add('text-white', 'font-bold', 'py-3', 'px-4', 'rounded-lg', 'transition-all', 'duration-300', 'ease-in-out', 'focus:outline-none', 'focus:ring-2', 'focus:ring-opacity-75', 'focus:ring-offset-2', 'focus:ring-offset-gray-800');
        });

    </script>
</body>
</html>
