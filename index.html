<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MIDI Control Deck</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617; /* Slate 950 */
            background-image: radial-gradient(ellipse at top, #1e293b, #020617);
            color: #e2e8f0; /* Slate 200 */
            overflow-x: hidden;
        }
        .font-mono { font-family: 'Space Mono', monospace; }
        
        /* Glassmorphism Card Style */
        .control-card, .sidebar-section {
            background: rgba(30, 41, 59, 0.5); /* Slate 800 with 50% opacity */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.6); /* Slate 600 */
            transition: all 0.3s ease;
        }
        .control-card:hover {
            border-color: rgba(56, 189, 248, 0.7); /* Sky 400 */
            background: rgba(30, 41, 59, 0.7);
        }

        /* Edit Mode Transition */
        .edit-fields {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, opacity 0.3s ease-in-out, margin-top 0.4s ease-out;
        }
        .control-card.edit-mode .edit-fields {
            max-height: 200px;
            opacity: 1;
            margin-top: 1rem;
        }

        /* Radial Dial SVG */
        .dial-svg { transition: transform 0.2s ease; }
        .dial-track { stroke: #334155; }
        .dial-value {
            stroke: #22d3ee; /* Cyan 400 */
            transition: stroke-dashoffset 0.1s linear;
            filter: drop-shadow(0 0 3px rgba(34, 211, 238, 0.7));
        }

        /* Vertical Slider Style */
        .slider-container {
            height: 250px; /* Define a fixed height for the container */
        }
        .slider-track {
            background: #1e293b; /* Slate 800 */
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
        }
        .slider-value {
            background: linear-gradient(to top, #22d3ee, #2dd4bf); /* Cyan to Teal */
            transition: height 0.05s linear;
        }

        /* Button Pad Style */
        .btn-pad {
            background: radial-gradient(ellipse at center, #334155 0%, #1e293b 70%);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
            transition: all 0.1s ease;
        }
        .btn-pad.active {
            background: radial-gradient(ellipse at center, #2dd4bf 0%, #14b8a6 70%);
            box-shadow: 0 0 15px rgba(45, 212, 191, 0.7), 0 0 8px rgba(45, 212, 191, 0.5), inset 0 2px 4px rgba(0,0,0,0.4);
            transform: scale(1.05);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Sidebar Toggle */
        #sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        #sidebar.open {
            transform: translateX(0);
        }
        @media (min-width: 1024px) {
            #sidebar { transform: translateX(0); }
            #main-content { margin-left: 320px; } /* w-80 */
        }
        
        /* Input field styling */
        input, select {
            background-color: #1e293b; border: 1px solid #334155;
            color: #cbd5e1;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }
        input:focus, select:focus {
            border-color: #38bdf8;
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.3);
            outline: none;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-80 bg-slate-900/80 backdrop-blur-lg border-r border-slate-700/80 z-20 p-6 flex flex-col space-y-6 overflow-y-auto">
        <header>
            <h1 class="text-3xl font-extrabold text-white tracking-tighter"><span class="text-teal-400">Plate</span> 1 Deck</h1>
            <p class="text-slate-400 text-sm">Advanced MIDI Control Interface</p>
        </header>

        <section class="sidebar-section rounded-xl p-4">
            <div class="flex gap-3">
                <button id="connectButton" class="flex-1 text-sm px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-400/50 transition-all duration-200 transform hover:scale-105 active:scale-95 inline-flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"></path></svg>
                    Connect
                </button>
                <button id="disconnectButton" disabled class="flex-1 text-sm px-4 py-2 bg-slate-600 text-white font-semibold rounded-lg shadow-lg hover:bg-slate-500 disabled:bg-slate-700 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none transition-all duration-200 inline-flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    Disconnect
                </button>
            </div>
            <div id="ble-status" class="mt-3 text-center text-xs hidden">
                <p class="text-slate-400 uppercase font-medium tracking-wider">Bluetooth</p>
                <p id="ble-peer-name" class="font-semibold text-green-400">Disconnected</p>
            </div>
        </section>

        <section id="global-controls" class="sidebar-section rounded-xl p-4 space-y-4" style="display: none;">
            <div>
                <label class="text-sm font-medium text-slate-300">Preset Bank</label>
                <select id="bank-select" class="w-full mt-1 bg-slate-800 border border-slate-600 rounded-md p-2 text-sm focus:ring-sky-500 focus:border-sky-500"></select>
            </div>
            <div>
                <div class="flex justify-between items-center">
                    <label for="midiChannel" class="text-sm font-medium text-slate-300">MIDI Channel</label>
                    <span id="midiChannel-value" class="font-mono text-sky-300 text-sm">1</span>
                </div>
                <input type="range" id="midiChannel" min="1" max="16" class="w-full mt-1 update-on-release" data-action="midi_ch">
            </div>
            <div>
                <div class="flex justify-between items-center">
                    <label for="brightness" class="text-sm font-medium text-slate-300">Brightness</label>
                    <span id="brightness-value" class="font-mono text-sky-300 text-sm">255</span>
                </div>
                <input type="range" id="brightness" min="3" max="255" class="w-full mt-1 update-on-release" data-action="brightness">
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button id="bleToggleButton" class="text-sm px-4 py-2 text-white font-semibold rounded-lg shadow-md transition-all duration-200 inline-flex items-center justify-center gap-2"></button>
                <button id="startCalButton" class="text-sm px-4 py-2 bg-amber-600 text-white font-semibold rounded-lg shadow-md hover:bg-amber-500 transition-colors duration-200 inline-flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.055 11H5a2 2 0 012 2v1a1 1 0 001 1h4a1 1 0 001-1v-1a2 2 0 012-2h1.945a8.002 8.002 0 00-11.89 0zM10 2a8 8 0 100 16 8 8 0 000-16zM6.343 6.343a.75.75 0 011.06 0l2.25 2.25a.75.75 0 01-1.06 1.06L6.343 7.404a.75.75 0 010-1.06zm7.314 0a.75.75 0 010 1.06l-2.25 2.25a.75.75 0 11-1.06-1.06l2.25-2.25a.75.75 0 011.06 0z" clip-rule="evenodd"></path></svg>
                    Calibrate
                </button>
            </div>
        </section>

        <div class="mt-auto flex-shrink-0">
            <p class="text-slate-300 font-semibold mb-2 text-sm">Activity Log</p>
            <div id="log-area" class="h-32 rounded-lg shadow-inner bg-slate-900/70 p-2 text-xs font-mono overflow-y-auto"></div>
        </div>
    </aside>

    <!-- Main Content -->
    <main id="main-content" class="p-6 lg:p-8">
        <div class="flex justify-between items-center mb-6">
            <button id="sidebar-toggle" class="lg:hidden p-2 rounded-md bg-slate-700/50 hover:bg-slate-600">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
            <div class="flex items-center gap-4 ml-auto">
                <span class="text-sm text-slate-400">Mode:</span>
                <div class="flex items-center bg-slate-800 border border-slate-700 rounded-lg p-1">
                    <button id="perf-mode-btn" class="px-3 py-1 text-sm rounded-md bg-sky-500 text-white">Performance</button>
                    <button id="edit-mode-btn" class="px-3 py-1 text-sm rounded-md text-slate-400">Edit</button>
                </div>
            </div>
        </div>

        <div id="control-deck" class="grid grid-cols-1 xl:grid-cols-2 gap-8">
            <!-- Left Panel: Sliders and Buttons -->
            <div id="left-panel" class="grid grid-cols-2 gap-6">
                <!-- Sliders (Pots 5-8) and Buttons (1-4) will be generated here -->
            </div>
            <!-- Right Panel: Dials -->
            <div id="right-panel" class="grid grid-cols-2 gap-6">
                <!-- Dials (Pots 1-4) will be generated here -->
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE & DOM ELEMENTS ---
            let device, interfaceNumber, endpointIn, endpointOut;
            let keepReading = false;
            let isEditMode = false;
            const textEncoder = new TextEncoder();
            const textDecoder = new TextDecoder();

            const connectButton = document.getElementById('connectButton');
            const disconnectButton = document.getElementById('disconnectButton');
            const leftPanel = document.getElementById('left-panel');
            const rightPanel = document.getElementById('right-panel');
            const logArea = document.getElementById('log-area');
            const globalControls = document.getElementById('global-controls');
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const perfModeBtn = document.getElementById('perf-mode-btn');
            const editModeBtn = document.getElementById('edit-mode-btn');
            const bankSelect = document.getElementById('bank-select');

            // --- INITIALIZATION ---
            const initializeUI = () => {
                leftPanel.innerHTML = '<p class="col-span-full text-center text-slate-500">Connect device to begin...</p>';
                rightPanel.innerHTML = '';
                for(let i = 1; i <= 12; i++) {
                    const option = document.createElement('option');
                    option.value = i - 1;
                    option.textContent = `Bank ${i}`;
                    bankSelect.appendChild(option);
                }
            };

            // --- LOGGING ---
            const log = (msg) => {
                const p = document.createElement('p');
                p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
                logArea.prepend(p);
                while (logArea.children.length > 50) logArea.removeChild(logArea.lastChild);
            };

            // --- UI GENERATION ---
            const populateControls = (settings) => {
                leftPanel.innerHTML = '';
                rightPanel.innerHTML = '';
                
                const sliderContainer = document.createElement('div');
                sliderContainer.className = "grid grid-cols-2 gap-6";
                
                const buttonContainer = document.createElement('div');
                buttonContainer.className = "grid grid-cols-2 gap-6";

                // Create Dials (Pots 1-4) for the right panel
                for (let i = 0; i < 4; i++) {
                    const cc = settings.ccs[i];
                    const label = settings.labels[i] || `Pot ${i + 1}`;
                    const card = document.createElement('div');
                    card.className = 'control-card glass-pane rounded-2xl p-4 flex flex-col items-center justify-between aspect-square';
                    card.dataset.index = i;
                    card.dataset.cc = cc;
                    card.innerHTML = `
                        <div class="flex flex-col items-center justify-center text-center flex-grow w-full">
                            <div class="relative w-24 h-24">
                                <svg class="dial-svg w-full h-full" viewBox="0 0 100 100">
                                    <circle class="dial-track" cx="50" cy="50" r="45" stroke-width="10" fill="none"/>
                                    <circle class="dial-value" cx="50" cy="50" r="45" stroke-width="10" fill="none"
                                        stroke-linecap="round" transform="rotate(-90 50 50)"
                                        stroke-dasharray="282.74" stroke-dashoffset="282.74"/>
                                </svg>
                                <span class="dial-text absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 font-mono text-2xl text-white">0</span>
                            </div>
                            <span class="label-text font-semibold text-slate-200 mt-3 truncate w-full">${label}</span>
                        </div>
                        <div class="edit-fields w-full">
                            <div class="space-y-2">
                                <input type="text" value="${label}" maxlength="4" placeholder="Label" class="w-full bg-slate-900/80 border border-slate-600 rounded-md p-1.5 text-sm" data-action="label">
                                <input type="number" value="${cc}" min="0" max="127" placeholder="CC" class="w-full bg-slate-900/80 border border-slate-600 rounded-md p-1.5 text-sm font-mono text-center" data-action="cc">
                                <button class="save-btn w-full text-xs bg-sky-600 hover:bg-sky-500 rounded-md py-1.5 transition-colors mt-1">Save</button>
                            </div>
                        </div>
                    `;
                    rightPanel.appendChild(card);
                }

                // Create Sliders (Pots 5-8) for the left panel
                for (let i = 4; i < 8; i++) {
                    const cc = settings.ccs[i];
                    const label = settings.labels[i] || `Pot ${i + 1}`;
                    const card = document.createElement('div');
                    card.className = 'control-card glass-pane rounded-2xl p-4 flex flex-col items-center';
                    card.dataset.index = i;
                    card.dataset.cc = cc;
                    card.innerHTML = `
                        <div class="flex-grow flex flex-col items-center w-full">
                            <span class="label-text font-semibold text-slate-200 truncate">${label}</span>
                            <div class="relative w-12 h-64 mt-4 slider-track rounded-full">
                                <div class="slider-value absolute bottom-0 left-0 w-full rounded-full" style="height: 0%;"></div>
                            </div>
                            <span class="slider-text-value font-mono text-xl text-white mt-3">0</span>
                        </div>
                        <div class="edit-fields w-full">
                            <div class="space-y-2">
                                <input type="text" value="${label}" maxlength="4" placeholder="Label" class="w-full bg-slate-900/80 border border-slate-600 rounded-md p-1.5 text-sm" data-action="label">
                                <input type="number" value="${cc}" min="0" max="127" placeholder="CC" class="w-full bg-slate-900/80 border border-slate-600 rounded-md p-1.5 text-sm font-mono text-center" data-action="cc">
                                <button class="save-btn w-full text-xs bg-sky-600 hover:bg-sky-500 rounded-md py-1.5 transition-colors mt-1">Save</button>
                            </div>
                        </div>
                    `;
                    sliderContainer.appendChild(card);
                }

                // Create Buttons (1-4) for the left panel
                for (let i = 8; i < 12; i++) {
                    const cc = settings.ccs[i];
                    const label = settings.labels[i] || `Btn ${i - 7}`;
                    const card = document.createElement('div');
                    card.className = 'control-card glass-pane rounded-2xl p-4 flex flex-col items-center justify-between aspect-square';
                    card.dataset.index = i;
                    card.dataset.cc = cc;
                    card.innerHTML = `
                        <div class="flex-grow flex flex-col items-center justify-center w-full">
                           <div class="btn-pad w-20 h-20 rounded-2xl flex items-center justify-center">
                                <span class="btn-cc font-mono text-xl text-slate-300">${cc}</span>
                            </div>
                            <span class="label-text font-semibold text-slate-200 mt-2 truncate">${label}</span>
                        </div>
                        <div class="edit-fields w-full">
                             <div class="space-y-2">
                                <input type="text" value="${label}" maxlength="4" placeholder="Label" class="w-full bg-slate-900/80 border border-slate-600 rounded-md p-1.5 text-sm" data-action="label">
                                <input type="number" value="${cc}" min="0" max="127" placeholder="CC" class="w-full bg-slate-900/80 border border-slate-600 rounded-md p-1.5 text-sm font-mono text-center" data-action="cc">
                                <button class="save-btn w-full text-xs bg-sky-600 hover:bg-sky-500 rounded-md py-1.5 transition-colors mt-1">Save</button>
                            </div>
                        </div>
                    `;
                    buttonContainer.appendChild(card);
                }
                
                leftPanel.appendChild(sliderContainer);
                leftPanel.appendChild(buttonContainer);
                // Re-arrange left panel to be 2x4 grid
                leftPanel.innerHTML = `<div class="grid grid-cols-4 gap-6">${sliderContainer.innerHTML}${buttonContainer.innerHTML}</div>`;
            };
            
            const updateUIState = (isConnected) => {
                connectButton.disabled = isConnected;
                disconnectButton.disabled = !isConnected;
                globalControls.style.display = isConnected ? 'block' : 'none';
                if (!isConnected) {
                    leftPanel.innerHTML = '<p class="col-span-full text-center text-slate-500">Connect device to begin...</p>';
                    rightPanel.innerHTML = '';
                }
            };

            const populateGlobalSettings = (settings) => {
                document.getElementById('bank-select').value = settings.activeBank;
                document.getElementById('midiChannel').value = settings.midiChannel;
                document.getElementById('midiChannel-value').textContent = settings.midiChannel;
                document.getElementById('brightness').value = settings.brightness;
                document.getElementById('brightness-value').textContent = settings.brightness;
                
                const bleButton = document.getElementById('bleToggleButton');
                const bleStatusEl = document.getElementById('ble-status');
                const blePeerNameEl = document.getElementById('ble-peer-name');
                
                bleButton.innerHTML = settings.bleOn ? 'Disable BLE' : 'Enable BLE';
                bleButton.classList.toggle('bg-red-600', settings.bleOn);
                bleButton.classList.toggle('hover:bg-red-500', settings.bleOn);
                bleButton.classList.toggle('bg-green-600', !settings.bleOn);
                bleButton.classList.toggle('hover:bg-green-500', !settings.bleOn);

                if (settings.bleOn) {
                    bleStatusEl.classList.remove('hidden');
                    blePeerNameEl.textContent = (settings.blePeerName && settings.blePeerName.length > 0) ? settings.blePeerName : 'Advertising...';
                    blePeerNameEl.classList.toggle('text-green-400', (settings.blePeerName && settings.blePeerName.length > 0));
                    blePeerNameEl.classList.toggle('text-yellow-400', !(settings.blePeerName && settings.blePeerName.length > 0));
                } else {
                    bleStatusEl.classList.add('hidden');
                }
            };

            // --- VISUALIZERS ---
            const updateVisualizer = (cc, value) => {
                const card = document.querySelector(`[data-cc='${cc}']`);
                if (!card) return;

                const index = parseInt(card.dataset.index);
                if (index < 4) { // Dial
                    const dialValue = card.querySelector('.dial-value');
                    const dialText = card.querySelector('.dial-text');
                    const circumference = 282.74;
                    const offset = circumference - (value / 127) * circumference;
                    dialValue.style.strokeDashoffset = offset;
                    dialText.textContent = value;
                } else if (index < 8) { // Slider
                    const sliderValue = card.querySelector('.slider-value');
                    const sliderText = card.querySelector('.slider-text-value');
                    sliderValue.style.height = `${(value / 127) * 100}%`;
                    sliderText.textContent = value;
                } else { // Button
                    const pad = card.querySelector('.btn-pad');
                    pad.classList.toggle('active', value > 64);
                }
            };

            // --- WEBUSB LOGIC ---
            const sendCommand = async (command) => {
                if (!device) return;
                log(`SEND: ${command}`);
                try {
                    await device.transferOut(endpointOut, textEncoder.encode(command + '\n'));
                } catch (error) {
                    log(`ERROR: ${error.message}`);
                }
            };

            async function readLoop() {
                let incomingData = "";
                while (keepReading) {
                    try {
                        let result = await device.transferIn(endpointIn, 512);
                        if (result.status === 'ok' && result.data.byteLength > 0) {
                            incomingData += textDecoder.decode(result.data, { stream: true });
                            let newlineIndex;
                            while ((newlineIndex = incomingData.indexOf('\n')) !== -1) {
                                const line = incomingData.slice(0, newlineIndex).trim();
                                incomingData = incomingData.slice(newlineIndex + 1);

                                if (line.startsWith('{')) {
                                    try {
                                        const settings = JSON.parse(line);
                                        log("Received settings.");
                                        populateGlobalSettings(settings);
                                        populateControls(settings);
                                        settings.currentPotValues.forEach((val, i) => updateVisualizer(settings.ccs[i], val));
                                    } catch (e) { log(`JSON Error: ${e.message}`); }
                                } else if (line.startsWith('cc:')) {
                                    const parts = line.substring(3).split(',');
                                    if (parts.length === 2) updateVisualizer(parseInt(parts[0]), parseInt(parts[1]));
                                } else if (line.startsWith('bank_changed:')) {
                                    log("Bank changed on device. Requesting new settings.");
                                    setTimeout(() => sendCommand('get_settings'), 100);
                                } else {
                                    log(`DEVICE: ${line}`);
                                }
                            }
                        }
                    } catch (error) {
                        log(`Read loop error: ${error.message}`);
                        if (error.message.includes("disconnected")) {
                            disconnectButton.click();
                        }
                        keepReading = false;
                    }
                }
            }

            // --- EVENT LISTENERS ---
            connectButton.addEventListener('click', async () => {
                log("Attempting to connect...");
                connectButton.disabled = true;
                connectButton.textContent = 'Connecting...';
                try {
                    const devices = await navigator.usb.getDevices();
                    device = devices.find(d => d.vendorId === 0x000a);

                    if (!device) {
                        log("Device not pre-authorized. Requesting permission...");
                        device = await navigator.usb.requestDevice({ filters: [{ vendorId: 0x000a }] });
                    } else {
                        log("Found pre-authorized device.");
                    }
                    
                    await device.open();
                    if (device.configuration === null) await device.selectConfiguration(1);
                    for (const iface of device.configuration.interfaces) {
                        for (const alt of iface.alternates) {
                            if (alt.interfaceClass === 0xFF) {
                                interfaceNumber = iface.interfaceNumber;
                                for (const ep of alt.endpoints) {
                                    if (ep.direction === 'out') endpointOut = ep.endpointNumber;
                                    if (ep.direction === 'in') endpointIn = ep.endpointNumber;
                                }
                            }
                        }
                    }
                    if (interfaceNumber === undefined) throw new Error("Interface not found.");
                    await device.claimInterface(interfaceNumber);
                    await device.controlTransferOut({ requestType: 'class', recipient: 'interface', request: 0x22, value: 0x01, index: interfaceNumber });
                    
                    log("Device connected successfully!");
                    updateUIState(true);
                    keepReading = true;
                    readLoop();
                    await sendCommand("get_settings");

                } catch (error) {
                    log(`Connection failed: ${error.message}`);
                    updateUIState(false);
                } finally {
                    connectButton.innerHTML = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"></path></svg> Connect`;
                }
            });

            disconnectButton.addEventListener('click', async () => {
                if (!device) return;
                log("Disconnecting...");
                keepReading = false;
                try {
                    await device.close();
                } catch (error) {
                    log(`Disconnect error: ${error.message}`);
                } finally {
                    device = null;
                    updateUIState(false);
                    log("Disconnected.");
                }
            });

            sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('open'));

            perfModeBtn.addEventListener('click', () => {
                isEditMode = false;
                perfModeBtn.classList.add('bg-sky-500', 'text-white');
                editModeBtn.classList.remove('bg-sky-500', 'text-white');
                document.querySelectorAll('.control-card').forEach(c => c.classList.remove('edit-mode'));
            });
            editModeBtn.addEventListener('click', () => {
                isEditMode = true;
                editModeBtn.classList.add('bg-sky-500', 'text-white');
                perfModeBtn.classList.remove('bg-sky-500', 'text-white');
                document.querySelectorAll('.control-card').forEach(c => c.classList.add('edit-mode'));
            });

            bankSelect.addEventListener('change', (e) => sendCommand(`set_bank=${e.target.value}`));

            globalControls.addEventListener('change', (e) => {
                if (e.target.classList.contains('update-on-release')) {
                    sendCommand(`set_${e.target.dataset.action}=${e.target.value}`);
                }
            });
            globalControls.addEventListener('input', (e) => {
                if (e.target.id === 'brightness') document.getElementById('brightness-value').textContent = e.target.value;
                if (e.target.id === 'midiChannel') document.getElementById('midiChannel-value').textContent = e.target.value;
            });
            document.getElementById('bleToggleButton').addEventListener('click', () => sendCommand('toggle_ble'));
            document.getElementById('startCalButton').addEventListener('click', () => sendCommand('start_cal'));

            document.getElementById('control-deck').addEventListener('click', (e) => {
                if (e.target.classList.contains('save-btn')) {
                    const card = e.target.closest('.control-card');
                    const index = card.dataset.index;
                    const labelInput = card.querySelector('input[data-action="label"]');
                    const ccInput = card.querySelector('input[data-action="cc"]');
                    
                    sendCommand(`set_label=${index},${labelInput.value}`);
                    sendCommand(`set_cc=${index},${ccInput.value}`);
                    
                    setTimeout(() => sendCommand('get_settings'), 200);
                }
            });

            // --- START ---
            initializeUI();
        });
    </script>
</body>
</html>
